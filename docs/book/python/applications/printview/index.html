<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.83.1"><link rel=canonical type=text/html href=/docs/book/python/applications/><link rel=alternate type=application/rss+xml href=/docs/book/python/applications/index.xml><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Applications | Cybertraining</title><meta name=description content="by the Digital Science Center"><meta property="og:title" content="Applications"><meta property="og:description" content="by the Digital Science Center"><meta property="og:type" content="website"><meta property="og:url" content="/docs/book/python/applications/"><meta property="og:site_name" content="Cybertraining"><meta itemprop=name content="Applications"><meta itemprop=description content="by the Digital Science Center"><meta name=twitter:card content="summary"><meta name=twitter:title content="Applications"><meta name=twitter:description content="by the Digital Science Center"><link rel=preload href=/scss/main.min.f1d8af03c6fdc7a4791232f48aaeeacc2141515c23db240de46e28a072b0be0a.css as=style><link href=/scss/main.min.f1d8af03c6fdc7a4791232f48aaeeacc2141515c23db240de46e28a072b0be0a.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="text-uppercase font-weight-bold">Cybertraining</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/about/><span>About</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/docs/><i class="fas fa-book"></i><span class=active>Content</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/cybertraining-dsc/cybertraining-dsc.github.io/ target=_blank><i class="fab fa-github"></i><span>GitHub</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/book/python/applications/>Return to the regular view of this page</a>.</p></div><h1 class=title>Applications</h1><ul><li>1: <a href=#pg-56e94fe9e02446d78ac431c2741f68ad>Fingerprint Matching</a></li><li>2: <a href=#pg-99965c710c9d60b5429156c532c1aaf4>NIST Pedestrian and Face Detection :o2:</a></li></ul><div class=content><p>Gregor von Laszewski (<a href=mailto:laszewski@gmail.com>laszewski@gmail.com</a>)</p></div></div><div class=td-content><h1 id=pg-56e94fe9e02446d78ac431c2741f68ad>1 - Fingerprint Matching</h1><p>Gregor von Laszewski (<a href=mailto:laszewski@gmail.com>laszewski@gmail.com</a>)</p><hr><blockquote><p><img src=https://github.com/cloudmesh-community/book/raw/main/chapters/prg/python/fingerprint/images/warning.png alt=Warning> Please note that NIST has temporarily removed the</p></blockquote><p>![Warning</p><blockquote><h2 id=if-you-have-one-please-notify-us>Fingerprint data set. We, unfortunately, do not have a copy of the dataset.
If you have one, please notify us</h2></blockquote><p>Python is a flexible and popular language for running data analysis
pipelines. In this section, we will implement a solution for
fingerprint matching.</p><h2 id=overview>Overview</h2><p>Fingerprint recognition refers to the automated method for verifying a
match between two fingerprints and that is used to identify individuals
and verify their identity. Fingerprints (Figure 1) are the most widely
used form of biometric used to identify individuals.</p><p><img src=https://github.com/cloudmesh-community/book/raw/main/chapters/prg/python/fingerprint/images/fingerprints.png alt="Figure 1: Fingerprints"></p><p>Figure 1: Fingerprints</p><p>The automated fingerprint matching generally required the detection of
different fingerprint features (aggregate characteristics of ridges, and
minutia points) and then the use of fingerprint matching algorithm,
which can do both one-to-one and one-to-many matching operations.
Based on the number of matches a proximity score (distance or
similarity) can be calculated.</p><p>We use the following NIST dataset for the study:</p><p>Special Database 14 - NIST Mated Fingerprint Card Pairs 2.
(<a href=http://www.nist.gov/itl/iad/ig/special_dbases.cfm>http://www.nist.gov/itl/iad/ig/special\_dbases.cfm</a>)</p><h2 id=objectives>Objectives</h2><p>Match the fingerprint images from a probe set to a gallery set and
report the match scores.</p><h2 id=prerequisites>Prerequisites</h2><p>For this work we will use the following algorithms:</p><ul><li>MINDTCT: The NIST minutiae detector, which automatically locates and records ridge ending and bifurcations in a fingerprint image.
(<a href=http://www.nist.gov/itl/iad/ig/nbis.cfm>http://www.nist.gov/itl/iad/ig/nbis.cfm</a>)</li><li>BOZORTH3: A NIST fingerprint matching algorithm, which is a minutiae-based fingerprint-matching algorithm. It can do both one-to-one and one-to-many matching operations.
(<a href=http://www.nist.gov/itl/iad/ig/nbis.cfm>http://www.nist.gov/itl/iad/ig/nbis.cfm</a>)</li></ul><p>In order to follow along, you must have the NBIS tools which provide
<code>mindtct</code> and <code>bozorth3</code> installed. If you are on Ubuntu 16.04 Xenial,
the following steps will accomplish this:</p><pre><code>$ sudo apt-get update -qq
$ sudo apt-get install -y build-essential cmake unzip
$ wget &quot;http://nigos.nist.gov:8080/nist/nbis/nbis_v5_0_0.zip&quot;
$ unzip -d nbis nbis_v5_0_0.zip
$ cd nbis/Rel_5.0.0
$ ./setup.sh /usr/local --without-X11
$ sudo make
</code></pre><h2 id=implementation>Implementation</h2><ol><li>Fetch the fingerprint images from the web</li><li>Call out to external programs to prepare and compute the match
scored</li><li>Store the results in a database</li><li>Generate a plot to identify likely matches.</li></ol><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>urllib</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>zipfile</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>hashlib</span>
</code></pre></div><p>we will be interacting with the operating system and manipulating files
and their pathnames.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>os.path</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>os</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>sys</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>shutil</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>tempfile</span>
</code></pre></div><p>Some general useful utilities</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>itertools</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>functools</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>types</span>
<span style=color:#204a87;font-weight:700>from</span> <span style=color:#000>pprint</span> <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>pprint</span>
</code></pre></div><p>Using the <code>attrs</code> library provides some nice shortcuts to defining
objects</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>attr</span>
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>sys</span>
</code></pre></div><p>we will be randomly dividing the entire dataset, based on user input,
into the probe and gallery stets</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>random</span>
</code></pre></div><p>we will need to call out to the NBIS software. we will also be using
multiple processes to take advantage of all the cores on our machine</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>subprocess</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>multiprocessing</span>
</code></pre></div><p>As for plotting, we will use <code>matplotlib</code>, though there are many
alternatives.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>matplotlib.pyplot</span> <span style=color:#204a87;font-weight:700>as</span> <span style=color:#000>plt</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>pandas</span> <span style=color:#204a87;font-weight:700>as</span> <span style=color:#000>pd</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>numpy</span> <span style=color:#204a87;font-weight:700>as</span> <span style=color:#000>np</span>
</code></pre></div><p>Finally, we will write the results to a database.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>sqlite3</span>
</code></pre></div><h2 id=utility-functions>Utility functions</h2><p>Next, we will define some utility functions:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>take</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>iterable</span><span style=color:#000;font-weight:700>):</span>
    <span style=color:#4e9a06>&#34;Returns a generator of the first **n** elements of an iterable&#34;</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>itertools</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>islice</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>iterable</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>n</span> <span style=color:#000;font-weight:700>)</span>


<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>zipWith</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>function</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>iterables</span><span style=color:#000;font-weight:700>):</span>
    <span style=color:#4e9a06>&#34;Zip a set of **iterables** together and apply **function** to each tuple&#34;</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>group</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>itertools</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>izip</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>iterables</span><span style=color:#000;font-weight:700>):</span>
        <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#000>function</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>group</span><span style=color:#000;font-weight:700>)</span>


<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>uncurry</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>function</span><span style=color:#000;font-weight:700>):</span>
    <span style=color:#4e9a06>&#34;Transforms an N-arry **function** so that it accepts a single parameter of an N-tuple&#34;</span>
    <span style=color:#5c35cc;font-weight:700>@functools.wraps</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>function</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>wrapper</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#000;font-weight:700>):</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>function</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>args</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>wrapper</span>


<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>fetch_url</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>sha256</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>prefix</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;.&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>checksum_blocksize</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>**</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>dryRun</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#3465a4>False</span><span style=color:#000;font-weight:700>):</span>
    <span style=color:#4e9a06>&#34;&#34;&#34;Download a url.
</span><span style=color:#4e9a06>
</span><span style=color:#4e9a06>    :param url: the url to the file on the web
</span><span style=color:#4e9a06>    :param sha256: the SHA-256 checksum. Used to determine if the file was previously downloaded.
</span><span style=color:#4e9a06>    :param prefix: directory to save the file
</span><span style=color:#4e9a06>    :param checksum_blocksize: blocksize to used when computing the checksum
</span><span style=color:#4e9a06>    :param dryRun: boolean indicating that calling this function should do nothing
</span><span style=color:#4e9a06>    :returns: the local path to the downloaded file
</span><span style=color:#4e9a06>    :rtype:
</span><span style=color:#4e9a06>
</span><span style=color:#4e9a06>    &#34;&#34;&#34;</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#204a87;font-weight:700>not</span> <span style=color:#000>os</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>exists</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>prefix</span><span style=color:#000;font-weight:700>):</span>
        <span style=color:#000>os</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>makedirs</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>prefix</span><span style=color:#000;font-weight:700>)</span>

    <span style=color:#000>local</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>os</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>join</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>prefix</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>os</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>basename</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#000;font-weight:700>))</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>dryRun</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>local</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>os</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>exists</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>local</span><span style=color:#000;font-weight:700>):</span>
        <span style=color:#204a87;font-weight:700>print</span> <span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;Verifying checksum&#39;</span><span style=color:#000;font-weight:700>)</span>
        <span style=color:#000>chk</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hashlib</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sha256</span><span style=color:#000;font-weight:700>()</span>
        <span style=color:#204a87;font-weight:700>with</span> <span style=color:#204a87>open</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>local</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;rb&#39;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>as</span> <span style=color:#000>fd</span><span style=color:#000;font-weight:700>:</span>
            <span style=color:#204a87;font-weight:700>while</span> <span style=color:#3465a4>True</span><span style=color:#000;font-weight:700>:</span>
                <span style=color:#000>bits</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>read</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>checksum_blocksize</span><span style=color:#000;font-weight:700>)</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#204a87;font-weight:700>not</span> <span style=color:#000>bits</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>break</span>
                <span style=color:#000>chk</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>update</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bits</span><span style=color:#000;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>sha256</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>chk</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>hexdigest</span><span style=color:#000;font-weight:700>():</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>local</span>

    <span style=color:#204a87;font-weight:700>print</span> <span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;Downloading&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>url</span><span style=color:#000;font-weight:700>)</span>

    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>report</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sofar</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>blocksize</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>totalsize</span><span style=color:#000;font-weight:700>):</span>
        <span style=color:#000>msg</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;{}%</span><span style=color:#4e9a06>\r</span><span style=color:#4e9a06>&#39;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>format</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>100</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>sofar</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>blocksize</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>totalsize</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>)</span>
        <span style=color:#000>sys</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>stderr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>write</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#000;font-weight:700>)</span>

    <span style=color:#000>urllib</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>urlretrieve</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>local</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>report</span><span style=color:#000;font-weight:700>)</span>

    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>local</span>
</code></pre></div><h2 id=dataset>Dataset</h2><p>we will now define some global parameters</p><p>First, the fingerprint dataset</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#000>DATASET_URL</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;https://s3.amazonaws.com/nist-srd/SD4/NISTSpecialDatabase4GrayScaleImagesofFIGS.zip&#39;</span>
<span style=color:#000>DATASET_SHA256</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;4db6a8f3f9dc14c504180cbf67cdf35167a109280f121c901be37a80ac13c449&#39;</span>
</code></pre></div><p>We&rsquo;ll define how to download the dataset. This function is general
enough that it could be used to retrieve most files, but we will default
it to use the values from previous.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>prepare_dataset</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#3465a4>None</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>sha256</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#3465a4>None</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>prefix</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;.&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>skip</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#3465a4>False</span><span style=color:#000;font-weight:700>):</span>
    <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>url</span> <span style=color:#204a87;font-weight:700>or</span> <span style=color:#000>DATASET_URL</span>
    <span style=color:#000>sha256</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sha256</span> <span style=color:#204a87;font-weight:700>or</span> <span style=color:#000>DATASET_SHA256</span>
    <span style=color:#000>local</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fetch_url</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>sha256</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>sha256</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>prefix</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>prefix</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>dryRun</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>skip</span><span style=color:#000;font-weight:700>)</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#204a87;font-weight:700>not</span> <span style=color:#000>skip</span><span style=color:#000;font-weight:700>:</span>
        <span style=color:#204a87;font-weight:700>print</span> <span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;Extracting&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>local</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;to&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>prefix</span><span style=color:#000;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>zipfile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ZipFile</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>local</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;r&#39;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>as</span> <span style=color:#204a87>zip</span><span style=color:#000;font-weight:700>:</span>
            <span style=color:#204a87>zip</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>extractall</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>prefix</span><span style=color:#000;font-weight:700>)</span>

    <span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>_</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>os</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>splitext</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>local</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>name</span>


<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>locate_paths</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>path_md5list</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>prefix</span><span style=color:#000;font-weight:700>):</span>
    <span style=color:#204a87;font-weight:700>with</span> <span style=color:#204a87>open</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>path_md5list</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>as</span> <span style=color:#000>fd</span><span style=color:#000;font-weight:700>:</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>line</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>itertools</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>imap</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>str</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>strip</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>fd</span><span style=color:#000;font-weight:700>):</span>
            <span style=color:#000>parts</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>split</span><span style=color:#000;font-weight:700>()</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#204a87;font-weight:700>not</span> <span style=color:#204a87>len</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>parts</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>continue</span>
            <span style=color:#000>md5sum</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>path</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parts</span>
            <span style=color:#000>chksum</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Checksum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>md5sum</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>kind</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;md5&#39;</span><span style=color:#000;font-weight:700>)</span>
            <span style=color:#000>filepath</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>os</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>join</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>prefix</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>path</span><span style=color:#000;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#000>Path</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>checksum</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>chksum</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>filepath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>filepath</span><span style=color:#000;font-weight:700>)</span>


<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>locate_images</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>paths</span><span style=color:#000;font-weight:700>):</span>

    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>predicate</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>path</span><span style=color:#000;font-weight:700>):</span>
        <span style=color:#000>_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>os</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>splitext</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>filepath</span><span style=color:#000;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ext</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;.png&#39;</span><span style=color:#000;font-weight:700>]</span>

    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>path</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>itertools</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ifilter</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>predicate</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>paths</span><span style=color:#000;font-weight:700>):</span>
        <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#000>image</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>checksum</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>path</span><span style=color:#000;font-weight:700>)</span>
</code></pre></div><h2 id=data-model>Data Model</h2><p>we will define some classes so we have a nice API for working with the
dataflow. We set <code>slots=True</code> so that the resulting objects will be more
space-efficient.</p><h3 id=utilities>Utilities</h3><h4 id=checksum>Checksum</h4><p>The checksum consists of the actual hash value (<code>value</code>) as well as a
string representing the hashing algorithm. The validator enforces that
the algorithm can only be one of the listed acceptable methods</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#5c35cc;font-weight:700>@attr.s</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>slots</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#3465a4>True</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Checksum</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>object</span><span style=color:#000;font-weight:700>):</span>
  <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>attr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>()</span>
  <span style=color:#000>kind</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>attr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>validator</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>lambda</span> <span style=color:#000>o</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>a</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>v</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>v</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#4e9a06>&#39;md5 sha1 sha224 sha256 sha384 sha512&#39;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>split</span><span style=color:#000;font-weight:700>())</span>
</code></pre></div><h4 id=path>Path</h4><p><code>Path refers to an image's file path and associated</code>Checksum`. We get
the checksum &ldquo;for"free&rdquo; since the MD5 hash is provided for each
image in the dataset.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#5c35cc;font-weight:700>@attr.s</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>slots</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#3465a4>True</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Path</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>object</span><span style=color:#000;font-weight:700>):</span>
    <span style=color:#000>checksum</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>attr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>()</span>
    <span style=color:#000>filepath</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>attr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>()</span>
</code></pre></div><h4 id=image>Image</h4><p>The start of the data pipeline is the image. An <code>image</code> has an <code>id</code> (the
md5 hash) and the path to the image.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#5c35cc;font-weight:700>@attr.s</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>slots</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#3465a4>True</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>image</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>object</span><span style=color:#000;font-weight:700>):</span>
    <span style=color:#204a87>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>attr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>()</span>
    <span style=color:#000>path</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>attr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>()</span>
</code></pre></div><h3 id=mindtct>Mindtct</h3><p>The next step in the pipeline is to apply the <code>mindtct</code> program from
NBIS. A <code>mindtct</code> object, therefore, represents the results of applying
<code>mindtct</code> on an <code>image</code>. The <code>xyt</code> output is needed for the next step,
and the <code>image</code> attribute represents the image id.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#5c35cc;font-weight:700>@attr.s</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>slots</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#3465a4>True</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>mindtct</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>object</span><span style=color:#000;font-weight:700>):</span>
    <span style=color:#000>image</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>attr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>()</span>
    <span style=color:#000>xyt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>attr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>()</span>

    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>pretty</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>):</span>
        <span style=color:#000>d</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>dict</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>image</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>id</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>image</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>path</span><span style=color:#000;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>pprint</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>d</span><span style=color:#000;font-weight:700>)</span>
</code></pre></div><p>We need a way to construct a <code>mindtct</code> object from an <code>image</code> object. A
straightforward way of doing this would be to have a <code>from_image</code>
<code>@staticmethod</code> or <code>@classmethod</code>, but that doesn't work well with
<code>multiprocessing</code> as top-level functions work best as they need to be
serialized.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>mindtct_from_image</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>image</span><span style=color:#000;font-weight:700>):</span>
    <span style=color:#000>imgpath</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>os</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>abspath</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>image</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>filepath</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#000>tempdir</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tempfile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>mkdtemp</span><span style=color:#000;font-weight:700>()</span>
    <span style=color:#000>oroot</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>os</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>join</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tempdir</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;result&#39;</span><span style=color:#000;font-weight:700>)</span>

    <span style=color:#000>cmd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;mindtct&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>imgpath</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>oroot</span><span style=color:#000;font-weight:700>]</span>

    <span style=color:#204a87;font-weight:700>try</span><span style=color:#000;font-weight:700>:</span>
        <span style=color:#000>subprocess</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>check_call</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cmd</span><span style=color:#000;font-weight:700>)</span>

        <span style=color:#204a87;font-weight:700>with</span> <span style=color:#204a87>open</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>oroot</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#39;.xyt&#39;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>as</span> <span style=color:#000>fd</span><span style=color:#000;font-weight:700>:</span>
            <span style=color:#000>xyt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>read</span><span style=color:#000;font-weight:700>()</span>

        <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mindtct</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>image</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>image</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>id</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>xyt</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>xyt</span><span style=color:#000;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span>

    <span style=color:#204a87;font-weight:700>finally</span><span style=color:#000;font-weight:700>:</span>
        <span style=color:#000>shutil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>rmtree</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tempdir</span><span style=color:#000;font-weight:700>)</span>
</code></pre></div><h3 id=bozorth3>Bozorth3</h3><p>The final step in the pipeline is running the <code>bozorth3</code> from NBIS. The
<code>bozorth3</code> class represents the match being done: tracking the ids of
the probe and gallery images as well as the match score.</p><p>Since we will be writing these instances out to a database, we provide
some static methods for SQL statements. While there are many
Object-Relational-Model (ORM) libraries available for Python, this
approach keeps the current implementation simple.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#5c35cc;font-weight:700>@attr.s</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>slots</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#3465a4>True</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>bozorth3</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>object</span><span style=color:#000;font-weight:700>):</span>
    <span style=color:#000>probe</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>attr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>()</span>
    <span style=color:#000>gallery</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>attr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>()</span>
    <span style=color:#000>score</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>attr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>()</span>

    <span style=color:#5c35cc;font-weight:700>@staticmethod</span>
    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>sql_stmt_create_table</span><span style=color:#000;font-weight:700>():</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#39;CREATE TABLE IF NOT EXISTS bozorth3&#39;</span> \
             <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#39;(probe TEXT, gallery TEXT, score NUMERIC)&#39;</span>

    <span style=color:#5c35cc;font-weight:700>@staticmethod</span>
    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>sql_prepared_stmt_insert</span><span style=color:#000;font-weight:700>():</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#39;INSERT INTO bozorth3 VALUES (?, ?, ?)&#39;</span>

    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>sql_prepared_stmt_insert_values</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>):</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>probe</span><span style=color:#000;font-weight:700>,</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>gallery</span><span style=color:#000;font-weight:700>,</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>score</span>
</code></pre></div><p>In order to work well with <code>multiprocessing</code>, we define a class
representing the input parameters to <code>bozorth3</code> and a helper function
to run <code>bozorth3</code>. This way the pipeline definition can be kept simple
to a <code>map</code> to create the input and then a <code>map</code> to run the program.</p><p>As NBIS <code>bozorth3</code> can be called to compare one-to-one or one-to-many,
we will also dynamically choose between these approaches depending on if
the gallery attribute is a list or a single object.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#5c35cc;font-weight:700>@attr.s</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>slots</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#3465a4>True</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>bozorth3_input</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>object</span><span style=color:#000;font-weight:700>):</span>
    <span style=color:#000>probe</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>attr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>()</span>
    <span style=color:#000>gallery</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>attr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>()</span>

    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>run</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>):</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#204a87>isinstance</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>gallery</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>mindtct</span><span style=color:#000;font-weight:700>):</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bozorth3_from_one_to_one</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>probe</span><span style=color:#000;font-weight:700>,</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>gallery</span><span style=color:#000;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>elif</span> <span style=color:#204a87>isinstance</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>gallery</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>types</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ListType</span><span style=color:#000;font-weight:700>):</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bozorth3_from_one_to_many</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>probe</span><span style=color:#000;font-weight:700>,</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>gallery</span><span style=color:#000;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>else</span><span style=color:#000;font-weight:700>:</span>
            <span style=color:#204a87;font-weight:700>raise</span> <span style=color:#c00;font-weight:700>ValueError</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;Unhandled type for gallery: {}&#39;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>format</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>type</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>gallery</span><span style=color:#000;font-weight:700>)))</span>
</code></pre></div><p>The next is the top-level function to running <code>bozorth3</code>. It accepts an
instance of <code>bozorth3_input</code>. The is implemented as a simple top-level
wrapper so that it can be easily passed to the <code>multiprocessing</code>
library.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>run_bozorth3</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>input</span><span style=color:#000;font-weight:700>):</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>run</span><span style=color:#000;font-weight:700>()</span>
</code></pre></div><h4 id=running-bozorth3>Running Bozorth3</h4><p>There are two cases to handle: 1. One-to-one probe to gallery sets 1.
One-to-many probe to gallery sets</p><p>Both approaches are implemented next. The implementations follow the
same pattern: 1. Create a temporary directory within with to work 1.
Write the probe and gallery images to files in the temporary directory</p><ol><li>Call the <code>bozorth3</code> executable 1. The match score is written to
<code>stdout</code> which is captured and then parsed. 1. Return a <code>bozorth3</code>
instance for each match 1. Make sure to clean up the temporary directory</li></ol><h5 id=one-to-one>One-to-one</h5><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>bozorth3_from_one_to_one</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>probe</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>gallery</span><span style=color:#000;font-weight:700>):</span>
    <span style=color:#000>tempdir</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tempfile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>mkdtemp</span><span style=color:#000;font-weight:700>()</span>
    <span style=color:#000>probeFile</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>os</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>join</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tempdir</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;probe.xyt&#39;</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#000>galleryFile</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>os</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>join</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tempdir</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;gallery.xyt&#39;</span><span style=color:#000;font-weight:700>)</span>

    <span style=color:#204a87;font-weight:700>with</span> <span style=color:#204a87>open</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>probeFile</span><span style=color:#000;font-weight:700>,</span>   <span style=color:#4e9a06>&#39;wb&#39;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>as</span> <span style=color:#000>fd</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>fd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>write</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>probe</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>xyt</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>with</span> <span style=color:#204a87>open</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>galleryFile</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;wb&#39;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>as</span> <span style=color:#000>fd</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>fd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>write</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>gallery</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>xyt</span><span style=color:#000;font-weight:700>)</span>

    <span style=color:#000>cmd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;bozorth3&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>probeFile</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>galleryFile</span><span style=color:#000;font-weight:700>]</span>

    <span style=color:#204a87;font-weight:700>try</span><span style=color:#000;font-weight:700>:</span>
        <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>subprocess</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>check_output</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cmd</span><span style=color:#000;font-weight:700>)</span>
        <span style=color:#000>score</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>int</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>strip</span><span style=color:#000;font-weight:700>())</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bozorth3</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>probe</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>probe</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>image</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>gallery</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>gallery</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>image</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>score</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>score</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>finally</span><span style=color:#000;font-weight:700>:</span>
        <span style=color:#000>shutil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>rmtree</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tempdir</span><span style=color:#000;font-weight:700>)</span>
</code></pre></div><h5 id=one-to-many>One-to-many</h5><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>bozorth3_from_one_to_many</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>probe</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>galleryset</span><span style=color:#000;font-weight:700>):</span>
    <span style=color:#000>tempdir</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tempfile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>mkdtemp</span><span style=color:#000;font-weight:700>()</span>
    <span style=color:#000>probeFile</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>os</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>join</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tempdir</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;probe.xyt&#39;</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#000>galleryFiles</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[</span><span style=color:#000>os</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>join</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tempdir</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;gallery</span><span style=color:#4e9a06>%d</span><span style=color:#4e9a06>.xyt&#39;</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>i</span><span style=color:#000;font-weight:700>)</span>
                    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>i</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>_</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#204a87>enumerate</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>galleryset</span><span style=color:#000;font-weight:700>)]</span>

    <span style=color:#204a87;font-weight:700>with</span> <span style=color:#204a87>open</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>probeFile</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;wb&#39;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>as</span> <span style=color:#000>fd</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>fd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>write</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>probe</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>xyt</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>galleryFile</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>gallery</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>itertools</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>izip</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>galleryFiles</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>galleryset</span><span style=color:#000;font-weight:700>):</span>
        <span style=color:#204a87;font-weight:700>with</span> <span style=color:#204a87>open</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>galleryFile</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;wb&#39;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>as</span> <span style=color:#000>fd</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>fd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>write</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>gallery</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>xyt</span><span style=color:#000;font-weight:700>)</span>

    <span style=color:#000>cmd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;bozorth3&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;-p&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>probeFile</span><span style=color:#000;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>galleryFiles</span>

    <span style=color:#204a87;font-weight:700>try</span><span style=color:#000;font-weight:700>:</span>
        <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>subprocess</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>check_output</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cmd</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>strip</span><span style=color:#000;font-weight:700>()</span>
        <span style=color:#000>scores</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>map</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>int</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>split</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#39;</span><span style=color:#000;font-weight:700>))</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000;font-weight:700>[</span><span style=color:#000>bozorth3</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>probe</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>probe</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>image</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>gallery</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>gallery</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>image</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>score</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>score</span><span style=color:#000;font-weight:700>)</span>
               <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>score</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>gallery</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#204a87>zip</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>scores</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>galleryset</span><span style=color:#000;font-weight:700>)]</span>
    <span style=color:#204a87;font-weight:700>finally</span><span style=color:#000;font-weight:700>:</span>
        <span style=color:#000>shutil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>rmtree</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tempdir</span><span style=color:#000;font-weight:700>)</span>
</code></pre></div><h2 id=plotting>Plotting</h2><p>For plotting, we will operate only on the database. we will select a small
number of probe images and plot the score between them and the rest of
the gallery images.</p><p>The <code>mk_short_labels</code> helper function will be defined next.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>plot</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>dbfile</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>nprobes</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>):</span>
    <span style=color:#000>conn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sqlite3</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>connect</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>dbfile</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#000>results</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>read_sql</span><span style=color:#000;font-weight:700>(</span>
        <span style=color:#4e9a06>&#34;SELECT DISTINCT probe FROM bozorth3 ORDER BY score LIMIT &#39;</span><span style=color:#4e9a06>%s</span><span style=color:#4e9a06>&#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>nprobes</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#000>con</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>conn</span>
    <span style=color:#000;font-weight:700>)</span>
    <span style=color:#000>shortlabels</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mk_short_labels</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>results</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>probe</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#000>plt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>figure</span><span style=color:#000;font-weight:700>()</span>

    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>i</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>probe</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>results</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>probe</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>iteritems</span><span style=color:#000;font-weight:700>():</span>
        <span style=color:#000>stmt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;SELECT gallery, score FROM bozorth3 WHERE probe = ? ORDER BY gallery DESC&#39;</span>
        <span style=color:#000>matches</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>read_sql</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>probe</span><span style=color:#000;font-weight:700>,),</span> <span style=color:#000>con</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>conn</span><span style=color:#000;font-weight:700>)</span>
        <span style=color:#000>xs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>np</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>arange</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>len</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>matches</span><span style=color:#000;font-weight:700>),</span> <span style=color:#000>dtype</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>np</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>int</span><span style=color:#000;font-weight:700>)</span>
        <span style=color:#000>plt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>plot</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>xs</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>matches</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>score</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>label</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;probe </span><span style=color:#4e9a06>%s</span><span style=color:#4e9a06>&#39;</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>shortlabels</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>])</span>

    <span style=color:#000>plt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ylabel</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;Score&#39;</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#000>plt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>xlabel</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;Gallery&#39;</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#000>plt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>legend</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bbox_to_anchor</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>0.2</span><span style=color:#000;font-weight:700>))</span>
    <span style=color:#000>plt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>show</span><span style=color:#000;font-weight:700>()</span>
</code></pre></div><p>The image ids are long hash strings. In order to minimize the amount of
space on the figure the labels occupy, we provide a helper function to
create a short label that still uniquely identifies each probe image in
the selected sample</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>mk_short_labels</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>series</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#000;font-weight:700>):</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>size</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#204a87>xrange</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>start</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87>len</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>series</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>])):</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#204a87>len</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>series</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87>len</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>set</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>map</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>lambda</span> <span style=color:#000>s</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>s</span><span style=color:#000;font-weight:700>[:</span><span style=color:#000>size</span><span style=color:#000;font-weight:700>],</span> <span style=color:#000>series</span><span style=color:#000;font-weight:700>))):</span>
            <span style=color:#204a87;font-weight:700>break</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87>map</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>lambda</span> <span style=color:#000>s</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>s</span><span style=color:#000;font-weight:700>[:</span><span style=color:#000>size</span><span style=color:#000;font-weight:700>],</span> <span style=color:#000>series</span><span style=color:#000;font-weight:700>)</span>
</code></pre></div><h2 id=putting-it-all-together>Putting it all Together</h2><p>First, set up a temporary directory in which to work:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#000>pool</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>multiprocessing</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Pool</span><span style=color:#000;font-weight:700>()</span>
<span style=color:#000>prefix</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;/tmp/fingerprint_example/&#39;</span>
<span style=color:#204a87;font-weight:700>if</span> <span style=color:#204a87;font-weight:700>not</span> <span style=color:#000>os</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>exists</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>prefix</span><span style=color:#000;font-weight:700>):</span>
    <span style=color:#000>os</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>makedirs</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>prefix</span><span style=color:#000;font-weight:700>)</span>
</code></pre></div><p>Next, we download and extract the fingerprint images from NIST:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#ce5c00;font-weight:700>%%</span><span style=color:#000>time</span>
<span style=color:#000>dataprefix</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>prepare_dataset</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>prefix</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>prefix</span><span style=color:#000;font-weight:700>)</span>
</code></pre></div><pre><code>Verifying checksum Extracting
/tmp/fingerprint_example/NISTSpecialDatabase4GrayScaleImagesofFIGS.zip
to /tmp/fingerprint_example/ CPU times: user 3.34 s, sys: 645 ms,
total: 3.99 s Wall time: 4.01 s
</code></pre><p>Next, we will configure the location of the MD5 checksum file that
comes with the download</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#000>md5listpath</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>os</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>join</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>prefix</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;NISTSpecialDatabase4GrayScaleImagesofFIGS/sd04/sd04_md5.lst&#39;</span><span style=color:#000;font-weight:700>)</span>
</code></pre></div><p>Load the images from the downloaded files to start the analysis pipeline</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#ce5c00;font-weight:700>%%</span><span style=color:#000>time</span>
<span style=color:#204a87;font-weight:700>print</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;Loading images&#39;</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000>paths</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>locate_paths</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>md5listpath</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>dataprefix</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000>images</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>locate_images</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>paths</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000>mindtcts</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pool</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>map</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>mindtct_from_image</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>images</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>print</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;Done&#39;</span><span style=color:#000;font-weight:700>)</span>
</code></pre></div><pre><code>Loading images Done CPU times: user 187 ms, sys: 17 ms, total: 204 ms
Wall time: 1min 21s
</code></pre><p>We can examine one of the loaded images. Note that <code>image</code> refers to
the MD5 checksum that came with the image and the <code>xyt</code> attribute
represents the raw image data.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#204a87;font-weight:700>print</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>mindtcts</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>]</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>image</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>print</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>mindtcts</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>]</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>xyt</span><span style=color:#000;font-weight:700>[:</span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#000;font-weight:700>])</span>
</code></pre></div><pre><code>98b15d56330cb17f1982ae79348f711d 14 146 214 6 25 238 22 37 25 51 180 20
30 332 214
</code></pre><p>For example purposes we will only a use a small percentage of the
database, randomly selected, for pur probe and gallery datasets.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#000>perc_probe</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0.001</span>
<span style=color:#000>perc_gallery</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0.1</span>
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#ce5c00;font-weight:700>%%</span><span style=color:#000>time</span>
<span style=color:#204a87;font-weight:700>print</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;Generating samples&#39;</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000>probes</span>  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>random</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sample</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>mindtcts</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87>int</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>perc_probe</span>   <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#204a87>len</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>mindtcts</span><span style=color:#000;font-weight:700>)))</span>
<span style=color:#000>gallery</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>random</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sample</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>mindtcts</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87>int</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>perc_gallery</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#204a87>len</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>mindtcts</span><span style=color:#000;font-weight:700>)))</span>
<span style=color:#204a87;font-weight:700>print</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;|Probes| =&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87>len</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>probes</span><span style=color:#000;font-weight:700>))</span>
<span style=color:#204a87;font-weight:700>print</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;|Gallery|=&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87>len</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>gallery</span><span style=color:#000;font-weight:700>))</span>
</code></pre></div><pre><code>Generating samples = 4 = 400 CPU times: user 2 ms, sys: 0 ns, total: 2
ms Wall time: 993 µs
</code></pre><p>We can now compute the matching scores between the probe and gallery
sets. This will use all cores available on this workstation.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#ce5c00;font-weight:700>%%</span><span style=color:#000>time</span>
<span style=color:#204a87;font-weight:700>print</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;Matching&#39;</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#204a87>input</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[</span><span style=color:#000>bozorth3_input</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>probe</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>probe</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>gallery</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>gallery</span><span style=color:#000;font-weight:700>)</span>
         <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>probe</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>probes</span><span style=color:#000;font-weight:700>]</span>
<span style=color:#000>bozorth3s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pool</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>map</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>run_bozorth3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87>input</span><span style=color:#000;font-weight:700>)</span>
</code></pre></div><pre><code>Matching CPU times: user 19 ms, sys: 1 ms, total: 20 ms Wall time: 1.07
s
</code></pre><p><code>bozorth3s</code> is now a <code>list</code> of <code>lists</code> of <code>bozorth3</code> instances.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#204a87;font-weight:700>print</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;|Probes|  =&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87>len</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bozorth3s</span><span style=color:#000;font-weight:700>))</span>
<span style=color:#204a87;font-weight:700>print</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;|Gallery| =&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87>len</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bozorth3s</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>]))</span>
<span style=color:#204a87;font-weight:700>print</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;Result:&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>bozorth3s</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>][</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>])</span>
</code></pre></div><pre><code>= 4 = 400 Result: bozorth3(probe='caf9143b268701416fbed6a9eb2eb4cf',
gallery='22fa0f24998eaea39dea152e4a73f267', score=4)
</code></pre><p>Now add the results to the database</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#000>dbfile</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>os</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>join</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>prefix</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;scores.db&#39;</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000>conn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sqlite3</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>connect</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>dbfile</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000>cursor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>cursor</span><span style=color:#000;font-weight:700>()</span>
<span style=color:#000>cursor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>execute</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bozorth3</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sql_stmt_create_table</span><span style=color:#000;font-weight:700>())</span>
</code></pre></div><pre><code>&lt;sqlite3.Cursor at 0x7f8a2f677490&gt;
</code></pre><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#ce5c00;font-weight:700>%%</span><span style=color:#000>time</span>
<span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>group</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>bozorth3s</span><span style=color:#000;font-weight:700>:</span>
    <span style=color:#000>vals</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>map</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bozorth3</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sql_prepared_stmt_insert_values</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>group</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#000>cursor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>executemany</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bozorth3</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sql_prepared_stmt_insert</span><span style=color:#000;font-weight:700>(),</span> <span style=color:#000>vals</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>commit</span><span style=color:#000;font-weight:700>()</span>
    <span style=color:#204a87;font-weight:700>print</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;Inserted results for probe&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>group</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>]</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>probe</span><span style=color:#000;font-weight:700>)</span>
</code></pre></div><pre><code>Inserted results for probe caf9143b268701416fbed6a9eb2eb4cf Inserted
results for probe 55ac57f711eba081b9302eab74dea88e Inserted results for
probe 4ed2d53db3b5ab7d6b216ea0314beb4f Inserted results for probe
20f68849ee2dad02b8fb33ecd3ece507 CPU times: user 2 ms, sys: 3 ms, total:
5 ms Wall time: 3.57 ms
</code></pre><p>We now plot the results. Figure 2</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#000>plot</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>dbfile</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>nprobes</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>len</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>probes</span><span style=color:#000;font-weight:700>))</span>
</code></pre></div><p><img src=https://github.com/cloudmesh-community/book/raw/main/chapters/prg/python/fingerprint/images/fingerprint_matching_74_0.png alt="Figure 2: Result"></p><p>Figure 2: Result</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#000>cursor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>close</span><span style=color:#000;font-weight:700>()</span>
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-99965c710c9d60b5429156c532c1aaf4>2 - NIST Pedestrian and Face Detection :o2:</h1><p>Gregor von Laszewski (<a href=mailto:laszewski@gmail.com>laszewski@gmail.com</a>)</p><p><img src=https://github.com/cloudmesh-community/book/raw/main/chapters/prg/python/facedetection/images/no.png alt=No></p><p>No</p><p>Pedestrian and Face Detection uses OpenCV to identify people standing in
a picture or a video and NIST use case in this document is built with
Apache Spark and Mesos clusters on multiple compute nodes.</p><p>The example in this tutorial deploys software packages on OpenStack
using Ansible with its roles. See Figure 1, Figure 2, Figure 3, Figure 4</p><p><img src=https://github.com/cloudmesh-community/book/raw/main/chapters/prg/python/facedetection/images/image03.png alt="Figure 1: Original"></p><p>Figure 1: Original</p><p><img src=https://github.com/cloudmesh-community/book/raw/main/chapters/prg/python/facedetection/images/image05.png alt="Figure 2: Pedestrian Detected"></p><p>Figure 2: Pedestrian Detected</p><p><img src=https://github.com/cloudmesh-community/book/raw/main/chapters/prg/python/facedetection/images/image06.png alt="Figure 3: Original"></p><p>Figure 3: Original</p><p><img src=https://github.com/cloudmesh-community/book/raw/main/chapters/prg/python/facedetection/images/image04.png alt="Figure 4: Pedestrian and Face/eyes Detected"></p><p>Figure 4: Pedestrian and Face/eyes Detected</p><h3 id=introduction>Introduction</h3><p>Human (pedestrian) detection and face detection have been studied during
the last several years and models for them have improved along with
Histograms of Oriented Gradients (HOG) for Human Detection [1]. OpenCV
is a Computer Vision library including the SVM classifier and the HOG
object detector for pedestrian detection and INRIA Person Dataset [2]
is one of the popular samples for both training and testing purposes. In
this document, we deploy Apache Spark on Mesos clusters to train and
apply detection models from OpenCV using Python API.</p><h4 id=inria-person-dataset>INRIA Person Dataset</h4><p>This dataset contains positive and negative images for training and test
purposes with annotation files for upright persons in each image. 288
positive test images, 453 negative test images, 614 positive training
images, and 1218 negative training images are included along with
normalized 64x128 pixel formats. 970MB dataset is available to download
[3].</p><h4 id=hog-with-svm-model>HOG with SVM model</h4><p>Histogram of Oriented Gradient (HOG) and Support Vector Machine (SVM)
are used as object detectors and classifiers and built-in python
libraries from OpenCV provide these models for human detection.</p><h4 id=ansible-automation-tool>Ansible Automation Tool</h4><p>Ansible is a python tool to install/configure/manage software on
multiple machines with JSON files where system descriptions are defined.
There are reasons why we use Ansible:</p><ul><li><p>Expandable: Leverages Python (default) but modules can be written in
any language</p></li><li><p>Agentless: no setup required on a managed node</p></li><li><p>Security: Allows deployment from userspace; uses ssh for
authentication</p></li><li><p>Flexibility: only requires ssh access to privileged user</p></li><li><p>Transparency: YAML Based script files express the steps of
installing and configuring software</p></li><li><p>Modularity: Single Ansible Role (should) contain all required
commands and variables to deploy software package independently</p></li><li><p>Sharing and portability: roles are available from the source (GitHub,
bitbucket, GitLab, etc) or the Ansible Galaxy portal</p></li></ul><p>We use Ansible roles to install software packages for Human and Face
Detection which requires running OpenCV Python libraries on Apache Mesos
with a cluster configuration. Dataset is also downloaded from the web
using an ansible role.</p><h3 id=deployment-by-ansible>Deployment by Ansible</h3><p>Ansible is to deploy applications and build clusters for
batch-processing large datasets towards target machines e.g. VM
instances on OpenStack and we use Ansible roles with <em>include</em> directive
to organize layers of big data software stacks (BDSS). Ansible provides
abstractions by Playbook Roles and reusability by Include statements. We
define X application in X Ansible Role, for example, and use include
statements to combine with other applications e.g. Y or Z. The layers
exist in subdirectories (see next) to add modularity to your Ansible
deployment. For example, there are five roles used in this example that
are Apache Mesos in a scheduler layer, Apache Spark in a processing
layer, an OpenCV library in an application layer, INRIA Person Dataset in
a dataset layer, and a python script for human and face detection in an
analytics layer. If you have an additional software package to add, you
can simply add a new role in the main Ansible playbook with <em>include</em>
directive. With this, your Ansible playbook maintains simple but
flexible to add more roles without having a large single file which is
getting difficult to read when it deploys more applications on multiple
layers. The main Ansible playbook runs Ansible roles in order which look
like:</p><pre><code>```
include: sched/00-mesos.yml
include: proc/01-spark.yml
include: apps/02-opencv.yml
include: data/03-inria-dataset.yml
Include: anlys/04-human-face-detection.yml
```
</code></pre><p>Directory names e.g. sched, proc, data, or anlys indicate BDSS layers
like: - sched: scheduler layer - proc: data processing layer - apps:
application layer - data: dataset layer - anlys: analytics layer and two
digits in the filename indicate an order of roles to be run.</p><h3 id=cloudmesh-for-provisioning>Cloudmesh for Provisioning</h3><p>It is assumed that virtual machines are created by cloudmesh, the cloud
management software. For example on OpenStack,</p><p><code>cm cluster create -N=6</code></p><p>command starts a set of virtual machine instances. The number of
machines and groups for clusters e.g. namenodes and datanodes are
defined in the Ansible inventory file, a list of target machines with
groups, which will be generated once machines are ready to use by
cloudmesh. Ansible roles install software and dataset on virtual
clusters after that stage.</p><h3 id=roles-explained-for-installation>Roles Explained for Installation</h3><p>Mesos role is installed first as a scheduler layer for masters and
slaves where mesos-master runs on the masters group and mesos-slave runs
on the slaves group. Apache Zookeeper is included in the mesos role
therefore mesos slaves find an elected mesos leader for the
coordination. Spark, as a data processing layer, provides two options
for distributed job processing, batch job processing via a cluster mode
and real-time processing via a client mode. The Mesos dispatcher runs on
a masters group to accept a batch job submission and Spark interactive
shell, which is the client mode, provides real-time processing on any
node in the cluster. Either way, Spark is installed later to detect a
master (leader) host for a job submission. Other roles for OpenCV, INRIA
Person Dataset and Human and Face Detection Python applications are
followed by.</p><p>The following software is expected in the stacks according to the
<a href=https://github.com/futuresystems/pedestrian-and-face-detection>github</a>:</p><ul><li><p>mesos cluster (master, worker)</p></li><li><p>spark (with dispatcher for mesos cluster mode)</p></li><li><p>openCV</p></li><li><p>zookeeper</p></li><li><p>INRIA Person Dataset</p></li><li><p>Detection Analytics in Python</p></li><li><p>[1] Dalal, Navneet, and Bill Triggs. &ldquo;Histograms of oriented
gradients for human detection.&rdquo; 2005 IEEE Computer Society
Conference on Computer Vision and Pattern Recognition (CVPR'05).
Vol. 1. IEEE,</p><p>2005. [pdf]</p></li><li><p>[2] <a href=http://pascal.inrialpes.fr/data/human/>http://pascal.inrialpes.fr/data/human/</a></p></li><li><p>[3] <a href=ftp://ftp.inrialpes.fr/pub/lear/douze/data/INRIAPerson.tar>ftp://ftp.inrialpes.fr/pub/lear/douze/data/INRIAPerson.tar</a></p></li><li><p>[4] <a href=https://docs.python.org/2/library/configparser.html>https://docs.python.org/2/library/configparser.html</a></p></li></ul><h4 id=server-groups-for-mastersslaves-by-ansible-inventory>Server groups for Masters/Slaves by Ansible inventory</h4><p>We may separate compute nodes in two groups: masters and workers
therefore Mesos masters and zookeeper quorums manage job requests and
leaders and workers run actual tasks. Ansible needs group definitions in
their inventory therefore software installation associated with a proper
part can be completed.</p><p>Example of Ansible Inventory file (inventory.txt)</p><pre><code>[masters]
10.0.5.67
10.0.5.68
10.0.5.69
[slaves]
10.0.5.70
10.0.5.71
10.0.5.72
</code></pre><h3 id=instructions-for-deployment>Instructions for Deployment</h3><p>The following commands complete NIST Pedestrian and Face Detection
deployment on OpenStack.</p><h4 id=cloning-pedestrian-detection-repository-from-github>Cloning Pedestrian Detection Repository from Github</h4><p>Roles are included as submodules that require <code>--recursive</code> option to
checkout them all.</p><pre><code>$ git clone --recursive https://github.com/futuresystems/pedestrian-and-face-detection.git
</code></pre><p>Change the following variable with actual ip addresses:</p><pre><code>sample_inventory=&quot;&quot;&quot;[masters]
10.0.5.67
10.0.5.68
10.0.5.69
[slaves]
10.0.5.70
10.0.5.71
10.0.5.72&quot;&quot;&quot;
</code></pre><p>Create an <code>inventory.txt</code> file with the variable in your local directory.</p><pre><code>!printf &quot;$sample_inventory&quot; &gt; inventory.txt
!cat inventory.txt
</code></pre><p>Add <code>ansible.cfg</code> file with options for ssh host key checking and login
name.</p><pre><code>ansible_config=&quot;&quot;&quot;[defaults]
host_key_checking=false
remote_user=ubuntu&quot;&quot;&quot;
!printf &quot;$ansible_config&quot; &gt; ansible.cfg
!cat ansible.cfg
</code></pre><p>Check accessibility by ansible ping like:</p><pre><code>!ansible -m ping -i inventory.txt all
</code></pre><p>Make sure that you have a correct ssh key in your account otherwise you
may encounter &lsquo;FAILURE&rsquo; in the previous ping test.</p><h4 id=ansible-playbook>Ansible Playbook</h4><p>We use a main Ansible playbook to deploy software packages for NIST
Pedestrian and Face detection which includes: - mesos - spark -zookeeper</p><ul><li><p>opencv - INRIA Person dataset - Python script for the detection</p><p>!cd pedestrian-and-face-detection/ && ansible-playbook -i ../inventory.txt site.yml</p></li></ul><p>The installation may take 30 minutes or an hour to complete.</p><h3 id=opencv-in-python>OpenCV in Python</h3><p>Before we run our code for this project, let&rsquo;s try OpenCV first to see
how it works.</p><h4 id=import-cv2>Import cv2</h4><p>Let us import opencv python module and we will use images from the online
database image-net.org to test OpenCV image recognition. See Figure 5, Figure 6</p><pre><code>import cv2
</code></pre><p>Let us download a mailbox image with a red color to see if opencv
identifies the shape with a color. The example file in this tutorial is:</p><pre><code>$ curl http://farm4.static.flickr.com/3061/2739199963_ee78af76ef.jpg &gt; mailbox.jpg
</code></pre><blockquote><p>100 167k 100 167k 0 0 686k 0 &ndash;:&ndash;:&ndash; &ndash;:&ndash;:&ndash; &ndash;:&ndash;:&ndash; 684k</p></blockquote><pre><code>%matplotlib inline

from IPython.display import Image
mailbox_image = &quot;mailbox.jpg&quot;
Image(filename=mailbox_image)
</code></pre><p><img src=https://github.com/cloudmesh-community/book/raw/main/chapters/prg/python/facedetection/images/facedetection_46_0.jpeg alt="Figure 5: Mailbox image"></p><p>Figure 5: Mailbox image</p><p>You can try other images. Check out the image-net.org for mailbox
images: <a href="http://image-net.org/synset?wnid=n03710193">http://image-net.org/synset?wnid=n03710193</a></p><h4 id=image-detection>Image Detection</h4><p>Just for a test, let&rsquo;s try to detect a red color shaped mailbox using
opencv python functions.</p><p>There are key functions that we use: * cvtColor: to convert a color
space of an image * inRange: to detect a mailbox based on the range of
red color pixel values * np.array: to define the range of red color
using a Numpy library for better calculation * findContours: to find a
outline of the object * bitwise_and: to black-out the area of contours
found</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>    <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>numpy</span> <span style=color:#204a87;font-weight:700>as</span> <span style=color:#000>np</span>
    <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>matplotlib.pyplot</span> <span style=color:#204a87;font-weight:700>as</span> <span style=color:#000>plt</span>

    <span style=color:#8f5902;font-style:italic># imread for loading an image</span>
    <span style=color:#000>img</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cv2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>imread</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>mailbox_image</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#8f5902;font-style:italic># cvtColor for color conversion</span>
    <span style=color:#000>hsv</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cv2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>cvtColor</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>img</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>cv2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>COLOR_BGR2HSV</span><span style=color:#000;font-weight:700>)</span>

    <span style=color:#8f5902;font-style:italic># define range of red color in hsv</span>
    <span style=color:#000>lower_red1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>np</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>array</span><span style=color:#000;font-weight:700>([</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>50</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>50</span><span style=color:#000;font-weight:700>])</span>
    <span style=color:#000>upper_red1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>np</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>array</span><span style=color:#000;font-weight:700>([</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>255</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>255</span><span style=color:#000;font-weight:700>])</span>
    <span style=color:#000>lower_red2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>np</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>array</span><span style=color:#000;font-weight:700>([</span><span style=color:#0000cf;font-weight:700>170</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>50</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>50</span><span style=color:#000;font-weight:700>])</span>
    <span style=color:#000>upper_red2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>np</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>array</span><span style=color:#000;font-weight:700>([</span><span style=color:#0000cf;font-weight:700>180</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>255</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>255</span><span style=color:#000;font-weight:700>])</span>

    <span style=color:#8f5902;font-style:italic># threshold the hsv image to get only red colors</span>
    <span style=color:#000>mask1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cv2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>inRange</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>hsv</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>lower_red1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>upper_red1</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#000>mask2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cv2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>inRange</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>hsv</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>lower_red2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>upper_red2</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#000>mask</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mask1</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>mask2</span>

    <span style=color:#8f5902;font-style:italic># find a red color mailbox from the image</span>
    <span style=color:#000>im2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>contours</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>hierarchy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cv2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>findContours</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>mask</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cv2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>RETR_TREE</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cv2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>CHAIN_APPROX_SIMPLE</span><span style=color:#000;font-weight:700>)</span>

    <span style=color:#8f5902;font-style:italic># bitwise_and to remove other areas in the image except the detected object</span>
    <span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cv2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>bitwise_and</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>img</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>img</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>mask</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mask</span><span style=color:#000;font-weight:700>)</span>

    <span style=color:#8f5902;font-style:italic># turn off - x, y axis bar</span>
    <span style=color:#000>plt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>axis</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;off&#34;</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#8f5902;font-style:italic># text for the masked image</span>
    <span style=color:#000>cv2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>putText</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>res</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;masked image&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>300</span><span style=color:#000;font-weight:700>),</span> <span style=color:#000>cv2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>FONT_HERSHEY_SIMPLEX</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>255</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>255</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>255</span><span style=color:#000;font-weight:700>))</span>
    <span style=color:#8f5902;font-style:italic># display</span>
    <span style=color:#000>plt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>imshow</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cv2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>cvtColor</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>res</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cv2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>COLOR_BGR2RGB</span><span style=color:#000;font-weight:700>))</span>
    <span style=color:#000>plt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>show</span><span style=color:#000;font-weight:700>()</span>
</code></pre></div><p><img src=https://github.com/cloudmesh-community/book/raw/main/chapters/prg/python/facedetection/images/facedetection_49_0.png alt="Figure 6: Masked image"></p><p>Figure 6: Masked image</p><p>The red color mailbox is left alone in the image which we wanted to find
in this example by OpenCV functions. You can try other images with
different colors to detect the different shape of objects using
findContours and inRange from opencv.</p><p>For more information, see the next useful links.</p><ul><li><p>contours features:
<a href=http://docs.opencv.org/3.1.0/dd/d49/tutorial/_py/_contour/_features.html>http://docs.opencv.org/3.1.0/dd/d49/tutorial/_py/_contour/_features.html</a></p></li><li><p>contours:
<a href=http://docs.opencv.org/3.1.0/d4/d73/tutorial/_py/_contours/_begin.html>http://docs.opencv.org/3.1.0/d4/d73/tutorial/_py/_contours/_begin.html</a></p></li><li><p>red color in hsv:
<a href=http://stackoverflow.com/questions/30331944/finding-red-color-using-python-opencv>http://stackoverflow.com/questions/30331944/finding-red-color-using-python-opencv</a></p></li><li><p>inrange:
<a href=http://docs.opencv.org/master/da/d97/tutorial/_threshold/_inRange.html>http://docs.opencv.org/master/da/d97/tutorial/_threshold/_inRange.html</a></p></li><li><p>inrange:
<a href=http://docs.opencv.org/3.0-beta/doc/py/_tutorials/py/_imgproc/py/_colorspaces/py/_colorspaces.html>http://docs.opencv.org/3.0-beta/doc/py/_tutorials/py/_imgproc/py/_colorspaces/py/_colorspaces.html</a></p></li><li><p>numpy:
<a href=http://docs.opencv.org/3.0-beta/doc/py/_tutorials/py/_core/py/_basic/_ops/py/_basic/_ops.html>http://docs.opencv.org/3.0-beta/doc/py/_tutorials/py/_core/py/_basic/_ops/py/_basic/_ops.html</a></p></li></ul><h3 id=human-and-face-detection-in-opencv>Human and Face Detection in OpenCV</h3><h4 id=inria-person-dataset-1>INRIA Person Dataset</h4><p>We use INRIA Person dataset to detect upright people and faces in images
in this example. Let us download it first.</p><pre><code>$ curl ftp://ftp.inrialpes.fr/pub/lear/douze/data/INRIAPerson.tar &gt; INRIAPerson.tar
</code></pre><blockquote><p>100 969M 100 969M 0 0 8480k 0 0:01:57 0:01:57 &ndash;:&ndash;:&ndash; 12.4M</p></blockquote><pre><code>$ tar xvf INRIAPerson.tar &gt; logfile &amp;&amp; tail logfile
</code></pre><h4 id=face-detection-using-haar-cascades>Face Detection using Haar Cascades</h4><p>This section is prepared based on the opencv-python tutorial:
<a href="http://docs.opencv.org/3.1.0/d7/d8b/tutorial/_py/_face/_detection.html#gsc.tab=0">http://docs.opencv.org/3.1.0/d7/d8b/tutorial/_py/_face/_detection.html#gsc.tab=0</a></p><p>There is a pre-trained classifier for face detection, download it from
here:</p><pre><code>$ curl https://raw.githubusercontent.com/opencv/opencv/master/data/haarcascades/haarcascade_frontalface_default.xml &gt; haarcascade_frontalface_default.xml
</code></pre><blockquote><p>100 908k 100 908k 0 0 2225k 0 &ndash;:&ndash;:&ndash; &ndash;:&ndash;:&ndash; &ndash;:&ndash;:&ndash; 2259k</p></blockquote><p>This classifier XML file will be used to detect faces in images. If you
like to create a new classifier, find out more information about
training from here:
<a href=http://docs.opencv.org/3.1.0/dc/d88/tutorial/_traincascade.html>http://docs.opencv.org/3.1.0/dc/d88/tutorial/_traincascade.html</a></p><h4 id=face-detection-python-code-snippet>Face Detection Python Code Snippet</h4><p>Now, we detect faces from the first five images using the classifier. See Figure 7, Figure 8, Figure 9, Figure 10, Figure 11, Figure 12, Figure 13, Figure 14, Figure 15, Figure 16, Figure 17</p><pre><code># import the necessary packages
import numpy as np
import cv2
from os import listdir
from os.path import isfile, join
import matplotlib.pyplot as plt

mypath = &quot;INRIAPerson/Test/pos/&quot;
face_cascade = cv2.CascadeClassifier('haarcascade_frontalface_default.xml')

onlyfiles = [join(mypath, f) for f in listdir(mypath) if isfile(join(mypath, f))]

cnt = 0
for filename in onlyfiles:
    image = cv2.imread(filename)
    image_grayscale = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)
    faces = face_cascade.detectMultiScale(image_grayscale, 1.3, 5)
    if len(faces) == 0:
        continue

    cnt_faces = 1
    for (x,y,w,h) in faces:
        cv2.rectangle(image,(x,y),(x+w,y+h),(255,0,0),2)
        cv2.putText(image, &quot;face&quot; + str(cnt_faces), (x,y-10), cv2.FONT_HERSHEY_SIMPLEX, 1, (0,0,0), 2)
        plt.figure()
        plt.axis(&quot;off&quot;)
        plt.imshow(cv2.cvtColor(image[y:y+h, x:x+w], cv2.COLOR_BGR2RGB))
        cnt_faces += 1
    plt.figure()
    plt.axis(&quot;off&quot;)
    plt.imshow(cv2.cvtColor(image, cv2.COLOR_BGR2RGB))
    cnt = cnt + 1
    if cnt == 5:
        break
</code></pre><p><img src=https://github.com/cloudmesh-community/book/raw/main/chapters/prg/python/facedetection/images/facedetection_59_0.png alt="Figure 7: Example"></p><p>Figure 7: Example</p><p><img src=https://github.com/cloudmesh-community/book/raw/main/chapters/prg/python/facedetection/images/facedetection_59_1.png alt="Figure 8: Example"></p><p>Figure 8: Example</p><p><img src=https://github.com/cloudmesh-community/book/raw/main/chapters/prg/python/facedetection/images/facedetection_59_2.png alt="Figure 9: Example"></p><p>Figure 9: Example</p><p><img src=https://github.com/cloudmesh-community/book/raw/main/chapters/prg/python/facedetection/images/facedetection_59_3.png alt="Figure 10: Example"></p><p>Figure 10: Example</p><p><img src=https://github.com/cloudmesh-community/book/raw/main/chapters/prg/python/facedetection/images/facedetection_59_4.png alt="Figure 11: Example"></p><p>Figure 11: Example</p><p><img src=https://github.com/cloudmesh-community/book/raw/main/chapters/prg/python/facedetection/images/facedetection_59_5.png alt="Figure 12: Example"></p><p>Figure 12: Example</p><p><img src=https://github.com/cloudmesh-community/book/raw/main/chapters/prg/python/facedetection/images/facedetection_59_6.png alt="Figure 13: Example"></p><p>Figure 13: Example</p><p><img src=https://github.com/cloudmesh-community/book/raw/main/chapters/prg/python/facedetection/images/facedetection_59_7.png alt="Figure 14: Example"></p><p>Figure 14: Example</p><p><img src=https://github.com/cloudmesh-community/book/raw/main/chapters/prg/python/facedetection/images/facedetection_59_8.png alt="Figure 15: Example"></p><p>Figure 15: Example</p><p><img src=https://github.com/cloudmesh-community/book/raw/main/chapters/prg/python/facedetection/images/facedetection_59_9.png alt="Figure 16: Example"></p><p>Figure 16: Example</p><p><img src=https://github.com/cloudmesh-community/book/raw/main/chapters/prg/python/facedetection/images/facedetection_59_10.png alt="Figure 17: Example"></p><p>Figure 17: Example</p><h3 id=pedestrian-detection-using-hog-descriptor>Pedestrian Detection using HOG Descriptor</h3><p>We will use Histogram of Oriented Gradients (HOG) to detect a upright
person from images. See Figure 18, Figure 19, Figure 20, Figure 21, Figure 22, Figure 23, Figure 24, Figure 25, Figure 26, Figure 27</p><h4 id=python-code-snippet>Python Code Snippet</h4><pre><code># initialize the HOG descriptor/person detector
hog = cv2.HOGDescriptor()
hog.setSVMDetector(cv2.HOGDescriptor_getDefaultPeopleDetector())

cnt = 0
for filename in onlyfiles:
    img = cv2.imread(filename)
    orig = img.copy()
    gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)

    # detect people in the image
    (rects, weights) = hog.detectMultiScale(img, winStride=(8, 8),
    padding=(16, 16), scale=1.05)

    # draw the final bounding boxes
    for (x, y, w, h) in rects:
        cv2.rectangle(img, (x, y), (x + w, y + h), (0, 255, 0), 2)

    plt.figure()
    plt.axis(&quot;off&quot;)
    plt.imshow(cv2.cvtColor(orig, cv2.COLOR_BGR2RGB))
    plt.figure()
    plt.axis(&quot;off&quot;)
    plt.imshow(cv2.cvtColor(img, cv2.COLOR_BGR2RGB))
    cnt = cnt + 1
    if cnt == 5:
        break
</code></pre><p><img src=https://github.com/cloudmesh-community/book/raw/main/chapters/prg/python/facedetection/images/facedetection_62_0.png alt="Figure 18: Example"></p><p>Figure 18: Example</p><p><img src=https://github.com/cloudmesh-community/book/raw/main/chapters/prg/python/facedetection/images/facedetection_62_1.png alt="Figure 19: Example"></p><p>Figure 19: Example</p><p><img src=https://github.com/cloudmesh-community/book/raw/main/chapters/prg/python/facedetection/images/facedetection_62_2.png alt="Figure 20: Example"></p><p>Figure 20: Example</p><p><img src=https://github.com/cloudmesh-community/book/raw/main/chapters/prg/python/facedetection/images/facedetection_62_3.png alt="Figure 21: Example"></p><p>Figure 21: Example</p><p><img src=https://github.com/cloudmesh-community/book/raw/main/chapters/prg/python/facedetection/images/facedetection_62_4.png alt="Figure 22: Example"></p><p>Figure 22: Example</p><p><img src=https://github.com/cloudmesh-community/book/raw/main/chapters/prg/python/facedetection/images/facedetection_62_5.png alt="Figure 23: Example"></p><p>Figure 23: Example</p><p><img src=https://github.com/cloudmesh-community/book/raw/main/chapters/prg/python/facedetection/images/facedetection_62_6.png alt="Figure 24: Example"></p><p>Figure 24: Example</p><p><img src=https://github.com/cloudmesh-community/book/raw/main/chapters/prg/python/facedetection/images/facedetection_62_7.png alt="Figure 25: Example"></p><p>Figure 25: Example</p><p><img src=https://github.com/cloudmesh-community/book/raw/main/chapters/prg/python/facedetection/images/facedetection_62_8.png alt="Figure 26: Example"></p><p>Figure 26: Example</p><p><img src=https://github.com/cloudmesh-community/book/raw/main/chapters/prg/python/facedetection/images/facedetection_62_9.png alt="Figure 27: Example"></p><p>Figure 27: Example</p><h3 id=processing-by-apache-spark>Processing by Apache Spark</h3><p>INRIA Person dataset provides 100+ images and Spark can be used for
image processing in parallel. We load 288 images from &ldquo;Test/pos&rdquo;
directory.</p><p>Spark provides a special object &lsquo;sc&rsquo; to connect between a spark cluster
and functions in python code. Therefore, we can run python functions in
parallel to detect objects in this example.</p><ul><li><p><em>map</em> function is used to process pedestrian and face detection per
image from the parallelize() function of &lsquo;sc&rsquo; spark context.</p></li><li><p><em>collect</em> function merges results in an array.</p><p>def apply_batch(imagePath):
import cv2
import numpy as np
# initialize the HOG descriptor/person detector
hog = cv2.HOGDescriptor()
hog.setSVMDetector(cv2.HOGDescriptor_getDefaultPeopleDetector())
image = cv2.imread(imagePath)
# detect people in the image
(rects, weights) = hog.detectMultiScale(image, winStride=(8, 8),
padding=(16, 16), scale=1.05)
# draw the final bounding boxes
for (x, y, w, h) in rects:
cv2.rectangle(image, (x, y), (x + w, y + h), (0, 255, 0), 2)
return image</p></li></ul><h4 id=parallelize-in-spark-context>Parallelize in Spark Context</h4><p>The list of image files is given to parallelize.</p><pre><code>pd = sc.parallelize(onlyfiles)
</code></pre><h4 id=map-function-apply_batch>Map Function (apply_batch)</h4><p>The &lsquo;apply_batch&rsquo; function that we created previously is given to map
function to process in a spark cluster.</p><pre><code>pdc = pd.map(apply_batch)
</code></pre><h4 id=collect-function>Collect Function</h4><p>The result of each map process is merged into an array.</p><pre><code>result = pdc.collect()
</code></pre><h3 id=results-for-100-images-by-spark-cluster>Results for 100+ images by Spark Cluster</h3><pre><code>for image in result:
    plt.figure()
    plt.axis(&quot;off&quot;)
    plt.imshow(cv2.cvtColor(image, cv2.COLOR_BGR2RGB))</code></pre></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Gregor von Laszewski" aria-label="Gregor von Laszewski"><a class=text-white target=_blank rel=noopener href=https://laszewski.github.io aria-label="Gregor von Laszewski"><i class="fa fa-envelope"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/cybertraining-dsc/cybertraining-dsc.github.io/ aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 Indiana University, 2020 All Rights Reserved</small><p class=mt-2><a href=/about/>About Cybertraining</a></p></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/mermaid@8.9.2/dist/mermaid.min.js integrity=sha384-uQikAXnCAqsMb3ygtdqBYvcwvHUkzGIpjdGyy9owhURXHUxLC5LgTcSxJQH/RzjK crossorigin=anonymous></script><script src=/js/deflate.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.2/dist/katex.min.css integrity=sha384-Cqd8ihRLum0CCg8rz0hYKPoLZ3uw+gES2rXQXycqnL5pgVQIflxAUDS7ZSjITLb5 crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.2/dist/katex.min.js integrity=sha384-1Or6BdeNQb0ezrmtGeqQHFpppNd7a/gw29xeiSikBbsb44xu3uAo8c7FwbF5jhbd crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.2/dist/contrib/mhchem.min.js integrity=sha384-LIgAiYlGSAdpNC9+YDjDPF6JeS/RRIumtNo0CmyQERZ/+g0h9MbuYQwf/5pQ4Y4M crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.2/dist/contrib/auto-render.min.js integrity=sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl crossorigin=anonymous onload=renderMathInElement(document.body,null)></script><script src=/js/main.min.758c0b1476eb0de973b63d0030f104f41a6eb3afb9908681605af4a48eb73018.js integrity="sha256-dYwLFHbrDelztj0AMPEE9Bpus6+5kIaBYFr0pI63MBg=" crossorigin=anonymous></script></body></html>